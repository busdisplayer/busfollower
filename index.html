<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAEIV - Simulateur avancé de déplacement</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .controls {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Simulateur avancé de ligne de tramway</h1>
    <div id="map"></div>
    <div class="controls">
        <h2>Simulateur de déplacement</h2>
        <label for="latitude">Latitude :</label>
        <input type="number" id="latitude" step="0.000001" value="45.448567">
        <label for="longitude">Longitude :</label>
        <input type="number" id="longitude" step="0.000001" value="4.361698">
        <button onclick="updatePosition()">Déplacer</button>
        <label for="direction">Sens de la ligne :</label>
        <select id="direction" onchange="updateDirection()">
            <option value="1">Vers l'arrêt 10</option>
            <option value="-1">Vers l'arrêt 1</option>
        </select>
    </div>
    <p id="result"></p>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Tableau des arrêts réels avec noms et coordonnées
        const tramStops = [
            { name: 'Arrêt 1', position: [45.447567, 4.361698] },
            { name: 'Arrêt 2', position: [45.450000, 4.361900] },
            { name: 'Arrêt 3', position: [45.452000, 4.362200] },
            { name: 'Arrêt 4', position: [45.454000, 4.362500] },
            { name: 'Arrêt 5', position: [45.456000, 4.362800] },
            { name: 'Arrêt 6', position: [45.458000, 4.363100] },
            { name: 'Arrêt 7', position: [45.460000, 4.363400] },
            { name: 'Arrêt 8', position: [45.462000, 4.363700] },
            { name: 'Arrêt 9', position: [45.464000, 4.364000] },
            { name: 'Arrêt 10', position: [45.466000, 4.364300] }
        ];

        let direction = 1; // 1 pour aller vers l'arrêt 10, -1 pour aller vers l'arrêt 1

        // Initialiser la carte
        const map = L.map('map').setView(tramStops[0].position, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Ajouter les arrêts à la carte
        tramStops.forEach((stop, index) => {
            L.marker(stop.position).addTo(map).bindPopup(`${stop.name}`);
        });

        // Marqueur pour la position actuelle
        let currentMarker = L.marker([45.448567, 4.361698], { color: 'red' }).addTo(map)
            .bindPopup("Position actuelle")
            .openPopup();

        // Calcul de la distance entre deux points (en mètres)
        function getDistance(lat1, lng1, lat2, lng2) {
            const earthRadius = 6371000; // Rayon de la Terre en mètres
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLng = (lng2 - lng1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return earthRadius * c;
        }

        // Trouver l'arrêt le plus proche
        function findClosestStop(currentLat, currentLng, stops) {
            let closestDistance = Infinity;
            let closestIndex = -1;

            stops.forEach((stop, index) => {
                let distance = getDistance(currentLat, currentLng, stop.position[0], stop.position[1]);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestIndex = index;
                }
            });

            return closestIndex;
        }

        // Fonction pour mettre à jour la position
        function updatePosition() {
            const currentLat = parseFloat(document.getElementById('latitude').value);
            const currentLng = parseFloat(document.getElementById('longitude').value);

            // Mettre à jour le marqueur de la position actuelle
            currentMarker.setLatLng([currentLat, currentLng]);
            map.setView([currentLat, currentLng], 15);

            // Trouver l'arrêt le plus proche
            const closestIndex = findClosestStop(currentLat, currentLng, tramStops);

            // Déterminer l'arrêt précédent et le suivant en fonction du sens
            let nextStop, prevStop;
            if (closestIndex !== -1) {
                if (direction === 1) { // Vers l'arrêt 10
                    prevStop = closestIndex === 0 ? null : closestIndex - 1;
                    nextStop = closestIndex === tramStops.length - 1 ? null : closestIndex + 1;
                } else { // Vers l'arrêt 1
                    prevStop = closestIndex === tramStops.length - 1 ? null : closestIndex + 1;
                    nextStop = closestIndex === 0 ? null : closestIndex - 1;
                }

                document.getElementById('result').innerHTML = `
                    Arrêt le plus proche : ${tramStops[closestIndex].name} <br>
                    Arrêt précédent : ${prevStop !== null ? tramStops[prevStop].name : 'N/A'} <br>
                    Arrêt suivant : ${nextStop !== null ? tramStops[nextStop].name : 'N/A'}
                `;
            }
        }

        // Mettre à jour la direction du trajet
        function updateDirection() {
            direction = parseInt(document.getElementById('direction').value);
            updatePosition();
        }

        // Mettre à jour automatiquement la position toutes les 15 secondes
        setInterval(updatePosition, 15000);

        // Initialiser la position pour le premier affichage
        updatePosition();
    </script>
</body>
</html>
